# KAIRO - Internacionalización (i18n)

> Guía completa para implementar y mantener la internacionalización en KAIRO.

## Stack i18n

| Librería | Propósito | Versión |
|----------|-----------|---------|
| next-intl | Traducciones y routing por locale | 3.x |

## Locales Soportados

| Código | Idioma | Estado |
|--------|--------|--------|
| `es` | Espanol (default) | [OK] Completo |
| `en` | English | [OK] Completo |

---

## Estructura de Archivos

```
src/
├── i18n/
│   ├── routing.ts          # Configuración de rutas localizadas
│   └── request.ts          # getMessages para Server Components
│
├── messages/
│   ├── es.json             # Traducciones en español
│   └── en.json             # Traducciones en inglés
│
├── middleware.ts           # Detecta y redirige por locale
│
└── app/
    └── [locale]/           # Dynamic segment para locale
        ├── layout.tsx      # NextIntlClientProvider
        ├── (auth)/
        │   └── login/
        └── (dashboard)/
            └── leads/
```

---

## Namespaces de Traducciones

Las traducciones están organizadas en namespaces semánticos:

| Namespace | Propósito | Ejemplo de uso |
|-----------|-----------|----------------|
| `common` | Botones, labels, mensajes genéricos | `tCommon('buttons.save')` |
| `navigation` | Items del sidebar y navegación | `t('dashboard')`, `t('leads')` |
| `login` | Página de login | `t('title')`, `t('errors.emailRequired')` |
| `leads` | Módulo de leads completo | `t('status.new')`, `t('temperature.hot')` |
| `dashboard` | Página de dashboard | `t('systemStatus')` |

### Estructura de `common`

```json
{
  "common": {
    "buttons": { "save", "cancel", "delete", "edit", ... },
    "actions": { "addNew", "clearFilters", "viewDetails", ... },
    "labels": { "all", "name", "email", "status", ... },
    "messages": { "noData", "error", "success", "loading" }
  }
}
```

### Estructura de `leads`

```json
{
  "leads": {
    "title": "Leads",
    "filters": { "search", "status", "temperature", "channel", "agent" },
    "stats": { "total", "new", "hot", "pipelineValue" },
    "status": { "new", "contacted", "qualified", "proposal", ... },
    "temperature": { "cold", "warm", "hot" },
    "channel": { "whatsapp", "email", "phone", "webchat", ... },
    "actions": { "changeStatus", "editLead", "assignAgent", ... },
    "table": { "name", "company", "status", ... },
    "detail": { "title", "email", "phone", ... },
    "empty": { "noLeads", "noResults" }
  }
}
```

---

## Cómo Usar Traducciones

### En Client Components ('use client')

```typescript
'use client';

import { useTranslations } from 'next-intl';

export function MyComponent() {
  // Un namespace
  const t = useTranslations('leads');

  // Múltiples namespaces
  const tCommon = useTranslations('common');

  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('status.new')}</p>
      <button>{tCommon('buttons.save')}</button>
    </div>
  );
}
```

### En Server Components

```typescript
import { getTranslations } from 'next-intl/server';

export default async function MyPage() {
  const t = await getTranslations('leads');

  return <h1>{t('title')}</h1>;
}
```

### Con Interpolación

```json
{
  "leads": {
    "showing": "Showing {filtered} of {total} leads"
  }
}
```

```typescript
t('showing', { filtered: 10, total: 25 })
// → "Showing 10 of 25 leads"
```

### Keys Dinámicas

```typescript
// Para estados, temperaturas, canales, etc.
const status = 'new';
t(`status.${status}`)  // → "New" o "Nuevo"

const temp = 'hot';
t(`temperature.${temp}`)  // → "Hot" o "Caliente"
```

---

## Agregar Nuevas Traducciones

### Paso 1: Agregar a ambos archivos JSON

**es.json:**
```json
{
  "miModulo": {
    "titulo": "Mi Título",
    "descripcion": "Mi descripción"
  }
}
```

**en.json:**
```json
{
  "miModulo": {
    "titulo": "My Title",
    "descripcion": "My description"
  }
}
```

### Paso 2: Usar en el componente

```typescript
const t = useTranslations('miModulo');

return <h1>{t('titulo')}</h1>;
```

### Paso 3: Validar con Playwright MCP

```bash
# Validar en ambos idiomas
1. Navegar a /es/mi-ruta
2. Verificar textos en español
3. Navegar a /en/mi-ruta
4. Verificar textos en inglés
```

---

## Formateo de Moneda

### Estado Actual

La función `formatCurrency` en `src/lib/utils.ts` está hardcodeada:

```typescript
export function formatCurrency(amount: number, currency: string = 'PEN'): string {
  return new Intl.NumberFormat('es-PE', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(amount);
}
```

**Limitaciones actuales:**
- Locale fijo: `es-PE` (Perú)
- Moneda por defecto: `PEN` (Sol peruano)
- No responde al locale del usuario

### Futuro: Moneda desde Backend

Cuando se implemente el backend con Supabase:

```typescript
// La moneda vendrá de la configuración de la empresa
interface Company {
  id: string;
  name: string;
  currency: 'PEN' | 'USD' | 'MXN' | 'COP' | ...;
  locale: 'es-PE' | 'en-US' | ...;
}
```

### Opción Alternativa: Locale-Aware

Si se necesita antes del backend:

```typescript
import { useLocale } from 'next-intl';

export function useFormatCurrency() {
  const locale = useLocale();

  const localeConfig = {
    es: { locale: 'es-PE', currency: 'PEN' },
    en: { locale: 'en-US', currency: 'USD' },
  };

  return (amount: number) => {
    const config = localeConfig[locale] || localeConfig.es;
    return new Intl.NumberFormat(config.locale, {
      style: 'currency',
      currency: config.currency,
    }).format(amount);
  };
}
```

---

## Formateo de Fechas

### Estado Actual

```typescript
export function formatDate(date: Date | string, options?: Intl.DateTimeFormatOptions): string {
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  return dateObj.toLocaleDateString('es-PE', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    ...options,
  });
}

export function formatRelativeTime(date: Date | string): string {
  // Retorna: "hace 2 min", "hace 1 h", etc.
  // Hardcodeado en español
}
```

### Consideraciones Futuras

- `formatDate` debería usar el locale actual
- `formatRelativeTime` debería traducir "hace X min" → "X min ago"
- Considerar usar `next-intl` formatters:

```typescript
import { useFormatter } from 'next-intl';

function MyComponent() {
  const format = useFormatter();

  // Fecha formateada según locale
  format.dateTime(date, { dateStyle: 'medium' });

  // Tiempo relativo
  format.relativeTime(date);
}
```

---

## Checklist para Nuevos Componentes

Antes de crear un nuevo componente, verificar:

- [ ] ¿Tiene texto visible para el usuario?
  - → Usar `useTranslations`
- [ ] ¿Muestra moneda/precios?
  - → Usar `formatCurrency` (documentar limitación)
- [ ] ¿Muestra fechas?
  - → Usar `formatDate` o `formatRelativeTime`
- [ ] ¿Tiene placeholders en inputs?
  - → Traducir con `t('filters.search')`
- [ ] ¿Tiene aria-labels?
  - → Traducir para accesibilidad
- [ ] ¿Tiene badges o estados?
  - → Usar keys dinámicas `t(\`status.${value}\`)`

---

## Patrones de Código

### Múltiples Namespaces en un Componente

```typescript
// Prefijo descriptivo para cada namespace
const t = useTranslations('leads');           // Dominio principal
const tCommon = useTranslations('common');     // Elementos compartidos
const tNav = useTranslations('navigation');    // Navegación
```

### Navigation Items con i18n

```typescript
interface NavItem {
  labelKey: string;  // Key de traducción, NO texto directo
  href: string;
  icon: React.ReactNode;
}

const items: NavItem[] = [
  { labelKey: 'dashboard', href: '/dashboard', icon: <HomeIcon /> },
  { labelKey: 'leads', href: '/leads', icon: <UsersIcon /> },
];

// En el render
{items.map(item => (
  <span>{t(item.labelKey)}</span>  // Traducido dinámicamente
))}
```

### Enums con Traducciones

```typescript
// types/index.ts
export enum LeadStatus {
  NEW = 'new',
  CONTACTED = 'contacted',
  // ...
}

// En el componente
{t(`status.${lead.status}`)}  // Traduce automáticamente
```

---

## Troubleshooting

### "Translation missing: leads.xxx"

1. Verificar que la key existe en **ambos** archivos JSON
2. Verificar ortografía exacta
3. Verificar namespace correcto

### Texto aparece en español en /en/

1. El componente puede tener texto hardcodeado
2. Agregar `useTranslations` y reemplazar strings
3. Validar con Playwright MCP

### Hydration Mismatch

Ocurre cuando Server y Client renderizan diferente:

```typescript
// [-] Mal - fecha cambia entre server y client
{new Date().toLocaleDateString()}

// [x] Bien - usar datos estables o suppressHydrationWarning
<time suppressHydrationWarning>
  {formatRelativeTime(date)}
</time>
```

---

## Archivos Relacionados

| Archivo | Propósito |
|---------|-----------|
| `src/i18n/routing.ts` | Configuración de locales y rutas |
| `src/i18n/request.ts` | Server-side message loading |
| `src/middleware.ts` | Detección y redirección de locale |
| `src/messages/es.json` | Traducciones español |
| `src/messages/en.json` | Traducciones inglés |
| `src/lib/utils.ts` | Funciones de formato (moneda, fecha) |
