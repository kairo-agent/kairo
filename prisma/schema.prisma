generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id              String               @id @default(cuid())
  name            String
  slug            String               @unique
  logoUrl         String?
  description     String?
  isActive        Boolean              @default(true)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  defaultTimezone String               @default("America/Lima")
  defaultLocale   String               @default("es-PE")
  members         OrganizationMember[]
  projects        Project[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  isOwner        Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

model Project {
  id                  String          @id @default(cuid())
  organizationId      String
  name                String
  slug                String
  logoUrl             String?
  description         String?
  plan                ProjectPlan     @default(free)
  defaultCurrency     CurrencyCode    @default(PEN)
  supportedCurrencies CurrencyCode[]  @default([PEN])
  exchangeRates       Json?
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  n8nWebhookUrl       String?
  n8nApiKey           String?
  whatsappPhoneNumber String?
  aiAgents            AIAgent[]
  leads               Lead[]
  members             ProjectMember[]
  secrets             ProjectSecret[]
  organization        Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@map("projects")
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(viewer)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model User {
  id                      String               @id
  email                   String               @unique
  firstName               String
  lastName                String
  avatarUrl               String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  preferences             Json                 @default("{\"theme\": \"light\", \"language\": \"es\", \"timezone\": \"America/Lima\", \"displayCurrency\": \"PEN\"}")
  isActive                Boolean              @default(true)
  systemRole              SystemRole           @default(user)
  timezone                String?
  locale                  String?
  performedActivities     Activity[]
  assignedLeads           Lead[]               @relation("AssignedUser")
  handoffLeads            Lead[]               @relation("HandoffUser")
  sentMessages            Message[]
  createdNotes            Note[]
  organizationMemberships OrganizationMember[]
  projectMemberships      ProjectMember[]

  @@index([email])
  @@index([systemRole])
  @@map("users")
}

model Lead {
  id              String          @id @default(cuid())
  firstName       String
  lastName        String
  email           String?
  phone           String?
  businessName    String?
  position        String?
  status          LeadStatus      @default(new)
  temperature     LeadTemperature @default(cold)
  source          LeadSource      @default(other)
  channel         LeadChannel
  type            LeadType        @default(manual)
  assignedAgentId String?
  assignedUserId  String?
  pipelineStage   String          @default("inbox")
  estimatedValue  Decimal?        @db.Decimal(12, 2)
  currency        CurrencyCode    @default(PEN)
  tags            String[]        @default([])
  lastContactAt   DateTime?
  nextFollowUpAt  DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  projectId       String
  handoffMode     HandoffMode     @default(ai)
  handoffAt       DateTime?
  handoffUserId   String?
  whatsappId      String?
  activities      Activity[]
  conversation    Conversation?
  assignedAgent   AIAgent?        @relation(fields: [assignedAgentId], references: [id])
  assignedUser    User?           @relation("AssignedUser", fields: [assignedUserId], references: [id])
  handoffUser     User?           @relation("HandoffUser", fields: [handoffUserId], references: [id])
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  notes           Note[]

  @@index([projectId])
  @@index([status])
  @@index([temperature])
  @@index([assignedAgentId])
  @@index([assignedUserId])
  @@index([handoffMode])
  @@index([whatsappId])
  @@index([createdAt])
  @@map("leads")
}

model AIAgent {
  id            String      @id @default(cuid())
  name          String
  type          AIAgentType
  description   String?
  avatarUrl     String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  stats         Json        @default("{\"satisfactionScore\": 0, \"totalConversations\": 0, \"averageResponseTime\": 0, \"totalLeadsGenerated\": 0}")
  projectId     String
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedLeads Lead[]

  @@index([projectId])
  @@index([type])
  @@map("ai_agents")
}

model Note {
  id        String   @id @default(cuid())
  leadId    String
  content   String
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User?    @relation(fields: [createdBy], references: [id])
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([createdBy])
  @@map("notes")
}

model Activity {
  id          String   @id @default(cuid())
  leadId      String
  type        String
  description String
  metadata    Json?
  performedBy String?
  createdAt   DateTime @default(now())
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  performer   User?    @relation(fields: [performedBy], references: [id])

  @@index([leadId])
  @@index([type])
  @@index([performedBy])
  @@index([createdAt])
  @@map("activities")
}

model Conversation {
  id        String    @id @default(cuid())
  leadId    String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([leadId])
  @@map("conversations")
}

model Message {
  id             String        @id @default(cuid())
  conversationId String
  sender         MessageSender
  content        String
  createdAt      DateTime      @default(now())
  sentByUserId   String?
  whatsappMsgId  String?
  metadata       Json?
  isDelivered    Boolean       @default(false)
  deliveredAt    DateTime?
  isRead         Boolean       @default(false)
  readAt         DateTime?
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sentByUser     User?         @relation(fields: [sentByUserId], references: [id])

  @@index([conversationId])
  @@index([sender])
  @@index([createdAt])
  @@index([whatsappMsgId])
  @@map("messages")
}

enum SystemRole {
  super_admin
  user
}

enum ProjectRole {
  admin
  manager
  agent
  viewer
}

enum ProjectPlan {
  free
  starter
  professional
  enterprise
}

enum LeadStatus {
  new
  contacted
  qualified
  proposal
  negotiation
  won
  lost
}

enum LeadTemperature {
  cold
  warm
  hot
}

enum LeadSource {
  website
  referral
  social_media
  advertising
  event
  other
}

enum LeadChannel {
  whatsapp
  email
  phone
  webchat
  instagram
  facebook
  other
}

enum LeadType {
  ai_agent
  manual
}

enum HandoffMode {
  ai
  human
}

enum MessageSender {
  ai
  human
  lead
}

enum AIAgentType {
  sales
  support
  qualification
  appointment
}

enum CurrencyCode {
  PEN
  USD
  EUR
  MXN
}

enum Theme {
  light
  dark
}

enum Locale {
  es
  en
}

// ============================================
// PROJECT SECRETS (Encrypted storage)
// ============================================

model ProjectSecret {
  id             String    @id @default(cuid())
  projectId      String
  key            String    // e.g., "whatsapp_access_token", "whatsapp_phone_number_id"
  encryptedValue String    @db.Text
  iv             String    // Initialization vector for AES-GCM
  authTag        String    // Authentication tag for integrity
  keyVersion     Int       @default(1) // For key rotation
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastAccessedAt DateTime?
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, key])
  @@index([projectId])
  @@map("project_secrets")
}

model SecretAccessLog {
  id        String   @id @default(cuid())
  projectId String
  secretKey String
  userId    String?
  action    String   // "read", "write", "delete"
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())

  @@index([projectId, timestamp])
  @@index([userId])
  @@map("secret_access_logs")
}
